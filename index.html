<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Mafia Game</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#0a0a0a;color:#fff;overflow:hidden;height:100vh;width:100vw}

/* ===== MAIN MENU ===== */
#main-menu{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#0a0a0a 0%,#1a0a2e 50%,#0a0a0a 100%);z-index:1000}
#main-menu h1{font-size:72px;letter-spacing:8px;margin-bottom:10px;background:linear-gradient(45deg,#ff0000,#ff6600,#ff0000);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:titlePulse 2s infinite}
@keyframes titlePulse{0%,100%{filter:brightness(1);transform:scale(1)}50%{filter:brightness(1.3);transform:scale(1.02)}}
#main-menu h2{font-size:18px;color:#888;margin-bottom:50px;letter-spacing:4px}
.menu-btn{padding:15px 40px;margin:10px;font-size:18px;border:2px solid #ff3333;background:rgba(255,0,0,0.1);color:#ff3333;cursor:pointer;letter-spacing:3px;text-transform:uppercase;transition:all .3s;min-width:300px;font-family:inherit}
.menu-btn:hover{background:rgba(255,0,0,0.3);transform:scale(1.05);box-shadow:0 0 30px rgba(255,0,0,0.3)}
.menu-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
#api-section{display:none;flex-direction:column;align-items:center;margin-top:20px}
#api-key-input{padding:12px 20px;width:400px;background:rgba(255,255,255,0.1);border:1px solid #444;color:#fff;font-size:14px;margin-bottom:10px;font-family:monospace}
#api-status{font-size:14px;margin-top:10px;color:#ff6666}
#api-status.connected{color:#66ff66}

/* ===== GAME ===== */
#game-container{display:none;width:100%;height:100%;position:relative}

/* 3D Scene */
#scene-3d{width:100%;height:100%;position:relative;overflow:hidden;background:#1a1a2e}
#sky{position:absolute;top:0;left:0;width:100%;height:55%;transition:background 2s}
.sky-day{background:linear-gradient(to bottom,#2a4a7c,#3a6a9c,#6a9abc)}
.sky-night{background:linear-gradient(to bottom,#000011,#050520,#0a0a3e)}
#ground{position:absolute;bottom:0;left:0;width:100%;height:45%;background:linear-gradient(to bottom,#2d5a27,#1a3a18,#0f2a0d);transition:background 2s}
.ground-night{background:linear-gradient(to bottom,#0a1a0a,#060f06,#030903)!important}

/* Buildings */
.bldg{position:absolute;bottom:45%;transform-origin:bottom center}
.bldg-body{position:absolute;bottom:0;border:1px solid rgba(255,255,255,0.08)}
.bldg-window{position:absolute;width:10px;height:14px;background:#ffcc44;border:1px solid rgba(0,0,0,0.3);transition:background .5s,box-shadow .5s}
.bldg-window.lit{background:#ffcc44;box-shadow:0 0 6px #ffcc44}
.bldg-window.dark{background:#1a1a2e;box-shadow:none}
.bldg-roof{position:absolute;width:0;height:0;border-left:solid transparent;border-right:solid transparent;border-bottom:solid}
.bldg-door{position:absolute;bottom:0;left:50%;transform:translateX(-50%);background:#3a2a1a;border:1px solid #2a1a0a;border-radius:2px 2px 0 0}

/* Celestial */
#celestial{position:absolute;width:50px;height:50px;border-radius:50%;transition:all 2s;z-index:5}
.cel-sun{background:radial-gradient(circle,#ffee88,#ffaa00);box-shadow:0 0 40px #ffaa00,0 0 80px rgba(255,170,0,0.3);top:8%;right:18%}
.cel-moon{background:radial-gradient(circle at 35% 35%,#eee,#aaa);box-shadow:0 0 20px rgba(180,180,255,0.3);top:6%;right:15%}

/* Stars */
.star{position:absolute;background:#fff;border-radius:50%;opacity:0;transition:opacity 2s}
.star.show{opacity:.7;animation:twinkle 3s infinite}
@keyframes twinkle{0%,100%{opacity:.7}50%{opacity:.2}}

/* Clouds */
.cloud{position:absolute;background:rgba(255,255,255,0.15);border-radius:50%;filter:blur(8px);transition:opacity 2s}
.cloud-night{opacity:.05!important}

/* Fence / Path */
#path{position:absolute;bottom:45%;left:0;width:100%;height:4px;background:linear-gradient(90deg,transparent,#5a4a3a,#5a4a3a,transparent)}

/* ===== SPRITE CANVAS ===== */
#sprite-area{position:absolute;bottom:2%;left:0;width:100%;height:42%;display:flex;align-items:flex-end;justify-content:center;flex-wrap:wrap;gap:2px;padding:0 10px;z-index:10}

.sprite-container{display:flex;flex-direction:column;align-items:center;position:relative;cursor:pointer;transition:transform .4s,opacity .4s,filter .4s}
.sprite-container.dead{opacity:.15;pointer-events:none;filter:grayscale(1)}
.sprite-container.dead .sprite-canvas{filter:grayscale(1) brightness(.3)}
.sprite-container.speaking{transform:translateY(-8px) scale(1.08);z-index:20}
.sprite-container.speaking .sprite-canvas{filter:brightness(1.2)}

.sprite-canvas{image-rendering:pixelated;width:48px;height:64px}

.sprite-name{font-size:8px;font-weight:bold;letter-spacing:1px;text-transform:uppercase;margin-top:2px;text-shadow:0 1px 3px #000,0 0 8px rgba(0,0,0,0.8)}
.sprite-role{font-size:6px;color:#aaa;margin-top:1px;display:none}

/* Speech Bubble */
.bubble{position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);border:2px solid;padding:6px 10px;border-radius:10px;font-size:10px;max-width:180px;min-width:60px;text-align:center;display:none;z-index:100;line-height:1.3;word-wrap:break-word;pointer-events:none}
.bubble::after{content:'';position:absolute;bottom:-7px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:7px solid transparent;border-right:7px solid transparent;border-top:7px solid rgba(0,0,0,0.9)}

/* ===== HUD ===== */
#hud{position:fixed;top:0;left:0;width:100%;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(to bottom,rgba(0,0,0,0.85),transparent);z-index:50;pointer-events:none}
#phase-display{font-size:22px;text-transform:uppercase;letter-spacing:4px;font-weight:bold}
.phase-day{color:#ffaa00}
.phase-night{color:#6666ff}
.phase-voting{color:#ff4444}
#timer-display{font-size:34px;font-weight:bold;color:#ff4444;font-family:'Courier New',monospace}
#day-counter{font-size:15px;color:#aaa}
#alive-counter{font-size:12px;color:#888;margin-top:2px}

/* ===== CHAT LOG ===== */
#chat-log{position:fixed;right:0;top:55px;width:300px;height:calc(100% - 110px);background:rgba(0,0,0,0.8);border-left:1px solid #222;overflow-y:auto;padding:8px;z-index:50;font-size:11px}
#chat-log::-webkit-scrollbar{width:4px}
#chat-log::-webkit-scrollbar-thumb{background:#333;border-radius:2px}
.chat-msg{padding:4px 8px;margin-bottom:3px;border-left:3px solid;background:rgba(255,255,255,0.02);line-height:1.4;animation:fadeMsg .3s}
@keyframes fadeMsg{from{opacity:0;transform:translateX(15px)}to{opacity:1;transform:translateX(0)}}
.chat-sender{font-weight:bold;font-size:10px}
.chat-text{color:#ccc}
.sys-msg{color:#ff8888;border-left-color:#ff4444!important;font-style:italic;text-align:center;background:rgba(255,0,0,0.04);font-size:10px}

/* ===== NIGHT OVERLAY ===== */
#night-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,20,0.6);z-index:15;display:none;pointer-events:none;transition:opacity 1s}

/* ===== NIGHT PANEL ===== */
#night-panel{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(8,8,30,0.96);border:2px solid #4444aa;border-radius:12px;padding:25px 30px;z-index:60;display:none;min-width:380px;max-width:550px;text-align:center;box-shadow:0 0 40px rgba(50,50,150,0.3)}
#night-panel h2{margin-bottom:12px;font-size:20px;letter-spacing:2px}
#night-panel-content{color:#ccc;font-size:13px;line-height:1.6;min-height:60px}

/* ===== VOTING ===== */
#voting-panel{position:fixed;bottom:0;left:0;width:calc(100% - 300px);background:rgba(60,0,0,0.92);padding:12px;z-index:55;display:none;border-top:2px solid #ff4444}
#voting-panel h3{text-align:center;margin-bottom:8px;color:#ff6666;letter-spacing:2px;font-size:14px}
#vote-tallies{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
.vote-entry{padding:4px 10px;background:rgba(0,0,0,0.5);border-radius:4px;font-size:11px;border:1px solid #333}

/* ===== GAME OVER ===== */
#game-over{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:2000}
#game-over h1{font-size:48px;margin-bottom:15px}
#game-over p{font-size:20px;color:#aaa;margin-bottom:25px}

/* ===== ROLE REVEAL ===== */
#role-reveal{position:fixed;top:0;left:0;width:100%;height:100%;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.95);z-index:2500;overflow-y:auto;padding:30px}
#role-reveal h2{font-size:20px;color:#aaa;margin-bottom:15px}
#revealed-roles{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;max-width:850px}
.rev-role{padding:6px 14px;border-radius:5px;font-size:12px;border:1px solid #333;background:rgba(0,0,0,0.7)}
</style>
</head>
<body>

<div id="main-menu">
    <h1>üî´ MAFIA</h1>
    <h2>Town of Shadows</h2>
    <button class="menu-btn" id="btn-connect" onclick="toggleApi()">üîë Connect to OpenRouter</button>
    <div id="api-section">
        <input type="text" id="api-key-input" placeholder="Paste your OpenRouter API key...">
        <button class="menu-btn" onclick="connectApi()">Connect</button>
        <div id="api-status"></div>
    </div>
    <button class="menu-btn" id="btn-start" onclick="startGame()" disabled>‚ñ∂ Start Game</button>
    <div style="margin-top:40px;color:#555;font-size:12px;max-width:500px;text-align:center;line-height:1.7">
        <b>20 Players:</b> 15 Townies ¬∑ 1 Doctor ¬∑ 1 Sheriff ¬∑ 3 Mafia<br>
        All bots powered by <b>Gemini 2.5 Flash</b> via OpenRouter
    </div>
</div>

<div id="game-container">
    <div id="scene-3d">
        <div id="sky" class="sky-day"></div>
        <div id="celestial" class="cel-sun"></div>
        <div id="ground"></div>
        <div id="path"></div>
        <div id="sprite-area"></div>
    </div>
    <div id="hud">
        <div><div id="day-counter">Day 1</div><div id="alive-counter"></div></div>
        <div id="phase-display" class="phase-day">‚òÄ DISCUSSION</div>
        <div id="timer-display">90</div>
    </div>
    <div id="chat-log"></div>
    <div id="night-overlay"></div>
    <div id="night-panel"><h2 id="np-title">üåô Night</h2><div id="np-content"></div></div>
    <div id="voting-panel"><h3>‚öñ VOTING</h3><div id="vote-tallies"></div></div>
</div>

<div id="game-over">
    <h1 id="go-title"></h1>
    <p id="go-text"></p>
    <button class="menu-btn" onclick="showRoles()">üìã Reveal Roles</button>
    <button class="menu-btn" onclick="location.reload()">üîÑ Play Again</button>
</div>

<div id="role-reveal">
    <h2>All Player Roles</h2>
    <div id="revealed-roles"></div>
    <button class="menu-btn" style="margin-top:20px" onclick="document.getElementById('role-reveal').style.display='none'">Close</button>
</div>

<script>
// ========== CONFIG ==========
let API_KEY='';
const API_URL='https://openrouter.ai/api/v1/chat/completions';
const MODEL='google/gemini-2.5-flash';
const DISCUSS_TIME=90, MAFIA_TIME=15;

// ========== COLORS ==========
const COLORS=[
    {name:'Crimson',   h:'#DC143C',b:'#8B0000',skin:'#FFD5B8',hat:'fedora',acc:'scar'},
    {name:'Azure',     h:'#007FFF',b:'#003F7F',skin:'#F5D0A9',hat:'beanie',acc:'glasses'},
    {name:'Emerald',   h:'#50C878',b:'#2E7D32',skin:'#FFDAB9',hat:'cap',acc:'beard'},
    {name:'Amber',     h:'#FFBF00',b:'#CC9900',skin:'#FFE0BD',hat:'tophat',acc:'monocle'},
    {name:'Violet',    h:'#8F00FF',b:'#5B00A3',skin:'#F0C8A0',hat:'beret',acc:'earring'},
    {name:'Coral',     h:'#FF7F50',b:'#CC5533',skin:'#FFD5C2',hat:'none',acc:'bandana'},
    {name:'Teal',      h:'#008080',b:'#005555',skin:'#FFDAB9',hat:'cap',acc:'mustache'},
    {name:'Magenta',   h:'#FF00FF',b:'#AA00AA',skin:'#FFE0C0',hat:'bow',acc:'lipstick'},
    {name:'Lime',      h:'#32CD32',b:'#228B22',skin:'#F5D0A9',hat:'beanie',acc:'freckles'},
    {name:'Ivory',     h:'#FFFFF0',b:'#CCCCAA',skin:'#FFE8D0',hat:'fedora',acc:'none'},
    {name:'Cyan',      h:'#00FFFF',b:'#009999',skin:'#FFDAB9',hat:'none',acc:'glasses'},
    {name:'Bronze',    h:'#CD7F32',b:'#8B5A2B',skin:'#D2A06B',hat:'cowboy',acc:'beard'},
    {name:'Lavender',  h:'#B57EDC',b:'#7B4FA2',skin:'#FFE0BD',hat:'bow',acc:'blush'},
    {name:'Scarlet',   h:'#FF2400',b:'#AA1800',skin:'#F0C8A0',hat:'cap',acc:'scar'},
    {name:'Silver',    h:'#C0C0C0',b:'#808080',skin:'#FFDAB9',hat:'tophat',acc:'monocle'},
    {name:'Gold',      h:'#FFD700',b:'#B8960F',skin:'#FFE0C0',hat:'crown',acc:'chain'},
    {name:'Slate',     h:'#708090',b:'#4A5568',skin:'#F5D0A9',hat:'beanie',acc:'stubble'},
    {name:'Rose',      h:'#FF007F',b:'#AA0055',skin:'#FFE0BD',hat:'bow',acc:'lipstick'},
    {name:'Peach',     h:'#FFCBA4',b:'#CC9966',skin:'#FFE8D8',hat:'none',acc:'freckles'},
    {name:'Indigo',    h:'#4B0082',b:'#2E004F',skin:'#D2A06B',hat:'fedora',acc:'glasses'},
];

// ========== STATE ==========
let players=[],gamePhase='menu',dayNum=0,timer=0,timerInt=null;
let chatHistory=[],nightAct={},voteRes={},speechQ=[],isSpeaking=false;

// ========== MENU ==========
function toggleApi(){const s=document.getElementById('api-section');s.style.display=s.style.display==='flex'?'none':'flex'}
function connectApi(){
    const k=document.getElementById('api-key-input').value.trim();
    if(!k){document.getElementById('api-status').textContent='‚ùå Enter a valid key';return}
    API_KEY=k;
    document.getElementById('api-status').textContent='‚úÖ Connected!';
    document.getElementById('api-status').className='connected';
    document.getElementById('btn-start').disabled=false;
}

// ========== SPRITE DRAWING ==========
function drawSprite(canvas,p){
    canvas.width=48;canvas.height=64;
    const ctx=canvas.getContext('2d');
    const c=COLORS[p.id];
    ctx.imageSmoothingEnabled=false;

    // Shadow on ground
    ctx.fillStyle='rgba(0,0,0,0.3)';
    ctx.beginPath();ctx.ellipse(24,62,14,3,0,0,Math.PI*2);ctx.fill();

    // Legs
    ctx.fillStyle=darken(c.b,0.7);
    ctx.fillRect(16,48,5,12); // left leg
    ctx.fillRect(27,48,5,12); // right leg
    // Shoes
    ctx.fillStyle=darken(c.b,0.4);
    ctx.fillRect(14,58,8,4);ctx.fillRect(26,58,8,4);

    // Body / torso
    ctx.fillStyle=c.h;
    ctx.beginPath();
    ctx.moveTo(14,30);ctx.lineTo(14,50);ctx.lineTo(34,50);ctx.lineTo(34,30);
    ctx.quadraticCurveTo(34,24,24,24);ctx.quadraticCurveTo(14,24,14,30);
    ctx.fill();
    ctx.strokeStyle=c.b;ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(14,30);ctx.lineTo(14,50);ctx.lineTo(34,50);ctx.lineTo(34,30);
    ctx.quadraticCurveTo(34,24,24,24);ctx.quadraticCurveTo(14,24,14,30);
    ctx.stroke();

    // Shirt detail - buttons or stripe
    ctx.fillStyle=darken(c.h,0.8);
    ctx.fillRect(23,28,2,2);ctx.fillRect(23,33,2,2);ctx.fillRect(23,38,2,2);

    // Belt
    ctx.fillStyle='#333';ctx.fillRect(14,46,20,3);
    ctx.fillStyle='#FFD700';ctx.fillRect(22,46,4,3);

    // Arms
    ctx.fillStyle=c.h;
    ctx.fillRect(6,28,8,5);  // left upper
    ctx.fillRect(34,28,8,5); // right upper
    ctx.fillStyle=darken(c.h,0.85);
    ctx.fillRect(5,33,7,10); // left forearm
    ctx.fillRect(36,33,7,10);// right forearm
    // Hands
    ctx.fillStyle=c.skin;
    ctx.fillRect(5,42,6,5);ctx.fillRect(37,42,6,5);

    // Neck
    ctx.fillStyle=c.skin;
    ctx.fillRect(21,18,6,7);

    // Head
    ctx.fillStyle=c.skin;
    ctx.beginPath();ctx.ellipse(24,13,9,10,0,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle=darken(c.skin,0.8);ctx.lineWidth=0.5;
    ctx.beginPath();ctx.ellipse(24,13,9,10,0,0,Math.PI*2);ctx.stroke();

    // Hair base
    ctx.fillStyle=getHairColor(p.id);
    ctx.beginPath();ctx.ellipse(24,9,10,7,0,Math.PI,Math.PI*2);ctx.fill();
    // Side hair
    ctx.fillRect(15,6,3,10);ctx.fillRect(30,6,3,10);

    // Eyes
    const eyeY=12;
    // Eye whites
    ctx.fillStyle='#fff';
    ctx.fillRect(19,eyeY,4,4);ctx.fillRect(26,eyeY,4,4);
    // Pupils
    ctx.fillStyle='#222';
    ctx.fillRect(20,eyeY+1,2,2);ctx.fillRect(27,eyeY+1,2,2);
    // Eye highlight
    ctx.fillStyle='#fff';
    ctx.fillRect(21,eyeY+1,1,1);ctx.fillRect(28,eyeY+1,1,1);

    // Eyebrows
    ctx.fillStyle=darken(getHairColor(p.id),0.7);
    ctx.fillRect(18,eyeY-2,5,1);ctx.fillRect(26,eyeY-2,5,1);

    // Nose
    ctx.fillStyle=darken(c.skin,0.85);
    ctx.fillRect(23,15,2,2);

    // Mouth
    ctx.fillStyle='#CC6666';
    ctx.fillRect(21,18,6,1);

    // ===== ACCESSORIES =====
    // Hat
    drawHat(ctx,c);

    // Accessory
    drawAccessory(ctx,c,p.id);

    // If dead, draw X eyes
    if(!p.alive){
        ctx.strokeStyle='#ff0000';ctx.lineWidth=2;
        ctx.beginPath();ctx.moveTo(19,11);ctx.lineTo(23,15);ctx.stroke();
        ctx.beginPath();ctx.moveTo(23,11);ctx.lineTo(19,15);ctx.stroke();
        ctx.beginPath();ctx.moveTo(26,11);ctx.lineTo(30,15);ctx.stroke();
        ctx.beginPath();ctx.moveTo(30,11);ctx.lineTo(26,15);ctx.stroke();
    }
}

function drawHat(ctx,c){
    switch(c.hat){
        case 'fedora':
            ctx.fillStyle=darken(c.h,0.6);
            ctx.fillRect(12,3,24,3); // brim
            ctx.fillRect(16,0,16,5); // crown
            ctx.fillStyle=darken(c.h,0.4);
            ctx.fillRect(16,4,16,1); // band
            break;
        case 'beanie':
            ctx.fillStyle=c.h;
            ctx.beginPath();ctx.ellipse(24,5,10,6,0,Math.PI,Math.PI*2);ctx.fill();
            ctx.fillStyle='#fff';
            ctx.beginPath();ctx.arc(24,0,2,0,Math.PI*2);ctx.fill();
            break;
        case 'cap':
            ctx.fillStyle=c.h;
            ctx.fillRect(14,4,20,4);
            ctx.fillStyle=darken(c.h,0.7);
            ctx.fillRect(10,7,14,2); // visor
            break;
        case 'tophat':
            ctx.fillStyle='#111';
            ctx.fillRect(12,2,24,2); // brim
            ctx.fillRect(16,-6,16,10); // tall part
            ctx.fillStyle=c.h;
            ctx.fillRect(16,-2,16,1); // band
            break;
        case 'beret':
            ctx.fillStyle=c.h;
            ctx.beginPath();ctx.ellipse(22,4,12,5,-.2,0,Math.PI*2);ctx.fill();
            break;
        case 'bow':
            ctx.fillStyle=c.h;
            // Bow on head
            ctx.beginPath();ctx.moveTo(20,3);ctx.lineTo(16,0);ctx.lineTo(20,1);ctx.fill();
            ctx.beginPath();ctx.moveTo(20,3);ctx.lineTo(24,0);ctx.lineTo(20,1);ctx.fill();
            ctx.fillRect(19,1,2,3);
            break;
        case 'cowboy':
            ctx.fillStyle='#8B6914';
            ctx.fillRect(8,4,32,2); // wide brim
            ctx.fillRect(15,0,18,6); // crown
            ctx.fillStyle='#654321';
            ctx.fillRect(15,4,18,1); // band
            break;
        case 'crown':
            ctx.fillStyle='#FFD700';
            ctx.fillRect(15,1,18,5);
            ctx.fillStyle='#FFD700';
            ctx.fillRect(15,-2,3,4);ctx.fillRect(21,-3,6,4);ctx.fillRect(30,-2,3,4);
            // Gems
            ctx.fillStyle='#ff0000';ctx.fillRect(23,2,2,2);
            ctx.fillStyle='#0066ff';ctx.fillRect(18,2,2,2);ctx.fillRect(28,2,2,2);
            break;
    }
}

function drawAccessory(ctx,c,id){
    switch(c.acc){
        case 'glasses':
            ctx.strokeStyle='#333';ctx.lineWidth=1;
            ctx.strokeRect(18,11,6,5);ctx.strokeRect(25,11,6,5);
            ctx.beginPath();ctx.moveTo(24,13);ctx.lineTo(25,13);ctx.stroke();
            ctx.beginPath();ctx.moveTo(15,13);ctx.lineTo(18,13);ctx.stroke();
            ctx.beginPath();ctx.moveTo(31,13);ctx.lineTo(34,13);ctx.stroke();
            break;
        case 'scar':
            ctx.strokeStyle='#cc4444';ctx.lineWidth=1;
            ctx.beginPath();ctx.moveTo(28,10);ctx.lineTo(32,18);ctx.stroke();
            break;
        case 'beard':
            ctx.fillStyle=darken(getHairColor(id),0.8);
            ctx.fillRect(18,17,12,4);ctx.fillRect(20,20,8,2);ctx.fillRect(22,21,4,2);
            break;
        case 'monocle':
            ctx.strokeStyle='#FFD700';ctx.lineWidth=1;
            ctx.beginPath();ctx.arc(28,13,4,0,Math.PI*2);ctx.stroke();
            ctx.beginPath();ctx.moveTo(28,17);ctx.lineTo(30,28);ctx.stroke();
            break;
        case 'earring':
            ctx.fillStyle='#FFD700';
            ctx.beginPath();ctx.arc(15,16,2,0,Math.PI*2);ctx.fill();
            break;
        case 'bandana':
            ctx.fillStyle=c.h;
            ctx.fillRect(15,6,18,3);
            ctx.fillStyle=darken(c.h,0.5);
            ctx.fillRect(31,7,5,6); // tail
            break;
        case 'mustache':
            ctx.fillStyle=darken(getHairColor(id),0.6);
            ctx.fillRect(19,16,4,2);ctx.fillRect(25,16,4,2);
            ctx.fillRect(17,17,2,1);ctx.fillRect(29,17,2,1);
            break;
        case 'lipstick':
            ctx.fillStyle='#ff2266';
            ctx.fillRect(21,18,6,1);
            break;
        case 'freckles':
            ctx.fillStyle='#c89060';
            ctx.fillRect(18,14,1,1);ctx.fillRect(20,15,1,1);ctx.fillRect(27,14,1,1);ctx.fillRect(29,15,1,1);
            ctx.fillRect(19,16,1,1);ctx.fillRect(28,16,1,1);
            break;
        case 'blush':
            ctx.fillStyle='rgba(255,100,100,0.3)';
            ctx.beginPath();ctx.ellipse(18,16,3,2,0,0,Math.PI*2);ctx.fill();
            ctx.beginPath();ctx.ellipse(30,16,3,2,0,0,Math.PI*2);ctx.fill();
            break;
        case 'stubble':
            ctx.fillStyle='rgba(100,100,100,0.4)';
            for(let i=0;i<12;i++){
                const sx=18+Math.random()*12,sy=16+Math.random()*6;
                ctx.fillRect(sx,sy,1,1);
            }
            break;
        case 'chain':
            ctx.strokeStyle='#FFD700';ctx.lineWidth=1;
            ctx.beginPath();ctx.moveTo(18,26);ctx.quadraticCurveTo(24,32,30,26);ctx.stroke();
            ctx.fillStyle='#FFD700';ctx.beginPath();ctx.arc(24,31,2,0,Math.PI*2);ctx.fill();
            break;
    }
}

function getHairColor(id){
    const hairs=['#2a1a0a','#1a0a00','#4a3020','#666','#3a2010','#221100','#553322','#111','#443322','#887766','#2a2a2a','#3a1a00','#332211','#1a0500','#aaa','#4a3a10','#333','#220a00','#5a4030','#0a0a0a'];
    return hairs[id%hairs.length];
}

function darken(hex,factor){
    let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
    r=Math.floor(r*factor);g=Math.floor(g*factor);b=Math.floor(b*factor);
    return '#'+[r,g,b].map(v=>Math.min(255,Math.max(0,v)).toString(16).padStart(2,'0')).join('');
}

// ========== BUILD SCENE ==========
function buildScene(){
    const scene=document.getElementById('scene-3d');

    // Stars
    for(let i=0;i<100;i++){
        const s=document.createElement('div');s.className='star';
        s.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*45}%;width:${1+Math.random()*2}px;height:${1+Math.random()*2}px;animation-delay:${Math.random()*4}s`;
        scene.appendChild(s);
    }

    // Clouds
    for(let i=0;i<6;i++){
        const cl=document.createElement('div');cl.className='cloud';
        cl.style.cssText=`left:${5+i*16}%;top:${5+Math.random()*15}%;width:${60+Math.random()*80}px;height:${20+Math.random()*15}px;opacity:${0.1+Math.random()*0.15}`;
        scene.appendChild(cl);
    }

    // Buildings
    const bldgs=[
        {l:2,w:70,h:160},{l:10,w:55,h:120},{l:19,w:80,h:190},{l:30,w:45,h:100},
        {l:62,w:50,h:110},{l:70,w:75,h:170},{l:80,w:60,h:140},{l:90,w:50,h:95}
    ];
    bldgs.forEach(b=>{
        const el=document.createElement('div');el.className='bldg';
        el.style.cssText=`left:${b.l}%;width:${b.w}px;height:${b.h}px`;

        const body=document.createElement('div');body.className='bldg-body';
        const shade=30+Math.random()*30;
        body.style.cssText=`width:100%;height:100%;background:linear-gradient(to top,rgb(${shade},${shade},${shade+15}),rgb(${shade+10},${shade+10},${shade+30}))`;
        el.appendChild(body);

        // Roof
        if(Math.random()>.4){
            const roof=document.createElement('div');roof.className='bldg-roof';
            roof.style.cssText=`top:-${15+Math.random()*15}px;left:-5px;border-left:${b.w/2+5}px solid transparent;border-right:${b.w/2+5}px solid transparent;border-bottom:${15+Math.random()*15}px solid rgb(${shade-10},${shade-5},${shade+5})`;
            el.appendChild(roof);
        }

        // Door
        const door=document.createElement('div');door.className='bldg-door';
        door.style.cssText=`width:${12+Math.random()*8}px;height:${18+Math.random()*6}px`;
        body.appendChild(door);

        // Windows
        const cols=Math.floor(b.w/22),rows=Math.floor(b.h/28);
        for(let r=1;r<rows;r++){
            for(let c=0;c<cols;c++){
                const win=document.createElement('div');
                win.className='bldg-window '+(Math.random()>.5?'lit':'dark');
                win.style.cssText=`left:${6+c*20}px;bottom:${8+r*26}px`;
                body.appendChild(win);
            }
        }
        scene.appendChild(el);
    });

    // Trees
    for(let i=0;i<5;i++){
        const tree=document.createElement('div');
        tree.style.cssText=`position:absolute;bottom:45%;left:${35+i*6}%`;
        tree.innerHTML=`<div style="width:4px;height:20px;background:#3a2a1a;margin:0 auto"></div>
        <div style="width:${16+Math.random()*10}px;height:${16+Math.random()*10}px;background:#2a6a2a;border-radius:50%;margin-top:-5px;margin-left:-${4+Math.random()*3}px"></div>`;
        scene.appendChild(tree);
    }

    // Lamp posts
    for(let i=0;i<3;i++){
        const lamp=document.createElement('div');
        lamp.style.cssText=`position:absolute;bottom:45%;left:${25+i*22}%`;
        lamp.innerHTML=`<div style="width:2px;height:30px;background:#555;margin:0 auto"></div>
        <div style="width:8px;height:5px;background:#444;border-radius:2px 2px 0 0;margin:-1px auto 0;position:relative">
        <div style="width:4px;height:3px;background:#ffdd88;margin:0 auto;box-shadow:0 0 10px #ffdd88,0 5px 20px rgba(255,220,100,0.2)"></div></div>`;
        scene.appendChild(lamp);
    }
}

// ========== INITIALIZE ==========
function initPlayers(){
    players=[];
    let roles=['Sheriff','Doctor','Mafia','Mafia','Mafia'];
    for(let i=0;i<15;i++)roles.push('Townie');
    shuffle(roles);
    for(let i=0;i<20;i++){
        players.push({
            id:i,name:COLORS[i].name,color:COLORS[i].h,darkColor:COLORS[i].b,
            skin:COLORS[i].skin,role:roles[i],alive:true,
            memory:[],accusations:{},knownInfo:[]
        });
    }
    const mafia=players.filter(p=>p.role==='Mafia');
    mafia.forEach(m=>{
        m.knownInfo.push(`You are MAFIA. Teammates: ${mafia.filter(x=>x.id!==m.id).map(x=>x.name).join(', ')}. Pretend to be a Townie. Never reveal you are Mafia.`);
    });
    const sh=players.find(p=>p.role==='Sheriff');
    if(sh)sh.knownInfo.push('You are the SHERIFF. Each night you investigate one player to learn if they are Mafia.');
    const doc=players.find(p=>p.role==='Doctor');
    if(doc)doc.knownInfo.push('You are the DOCTOR. Each night you protect one player from being killed.');
}

function renderSprites(){
    const area=document.getElementById('sprite-area');area.innerHTML='';
    players.forEach(p=>{
        const cont=document.createElement('div');
        cont.className='sprite-container'+(p.alive?'':' dead');
        cont.id='spr-'+p.id;

        const bubble=document.createElement('div');
        bubble.className='bubble';bubble.id='bub-'+p.id;
        bubble.style.borderColor=p.color;

        const canvas=document.createElement('canvas');
        canvas.className='sprite-canvas';canvas.id='cvs-'+p.id;
        drawSprite(canvas,p);

        const nm=document.createElement('div');
        nm.className='sprite-name';nm.style.color=p.color;nm.textContent=p.name;

        cont.appendChild(bubble);cont.appendChild(canvas);cont.appendChild(nm);
        area.appendChild(cont);
    });
    updateAliveCount();
}

function updateAliveCount(){
    const alive=players.filter(p=>p.alive);
    const m=alive.filter(p=>p.role==='Mafia').length;
    const t=alive.filter(p=>p.role!=='Mafia').length;
    document.getElementById('alive-counter').textContent=`Alive: ${alive.length} | Town: ${t} | Mafia: ${m} (hidden)`;
}

// ========== VISUALS ==========
function setDay(){
    document.getElementById('sky').className='sky-day';
    document.getElementById('celestial').className='cel-sun';
    document.getElementById('ground').classList.remove('ground-night');
    document.getElementById('night-overlay').style.display='none';
    document.querySelectorAll('.star').forEach(s=>s.classList.remove('show'));
    document.querySelectorAll('.cloud').forEach(c=>c.classList.remove('cloud-night'));
    document.querySelectorAll('.bldg-window').forEach(w=>{w.className='bldg-window '+(Math.random()>.6?'lit':'dark')});
}
function setNight(){
    document.getElementById('sky').className='sky-night';
    document.getElementById('celestial').className='cel-moon';
    document.getElementById('ground').classList.add('ground-night');
    document.getElementById('night-overlay').style.display='block';
    document.querySelectorAll('.star').forEach(s=>s.classList.add('show'));
    document.querySelectorAll('.cloud').forEach(c=>c.classList.add('cloud-night'));
    document.querySelectorAll('.bldg-window').forEach(w=>{w.className='bldg-window '+(Math.random()>.3?'lit':'dark')});
}

// ========== CHAT ==========
function addChat(p,text){
    const log=document.getElementById('chat-log');
    const m=document.createElement('div');m.className='chat-msg';m.style.borderLeftColor=p.color;
    m.innerHTML=`<span class="chat-sender" style="color:${p.color}">${p.name}:</span> <span class="chat-text">${text}</span>`;
    log.appendChild(m);log.scrollTop=log.scrollHeight;
    showBubble(p,text);
    const entry=`[Day${dayNum}] ${p.name}: ${text}`;
    chatHistory.push(entry);p.memory.push(entry);
    queueTTS(p,text);
}

function addSys(text){
    const log=document.getElementById('chat-log');
    const m=document.createElement('div');m.className='chat-msg sys-msg';m.textContent=text;
    log.appendChild(m);log.scrollTop=log.scrollHeight;
    chatHistory.push(`[SYS] ${text}`);
}

function showBubble(p,text){
    document.querySelectorAll('.bubble').forEach(b=>b.style.display='none');
    document.querySelectorAll('.sprite-container').forEach(c=>c.classList.remove('speaking'));
    const bub=document.getElementById('bub-'+p.id);
    const spr=document.getElementById('spr-'+p.id);
    if(bub&&spr){
        bub.textContent=text.length>70?text.substring(0,67)+'...':text;
        bub.style.display='block';spr.classList.add('speaking');
        setTimeout(()=>{bub.style.display='none';spr.classList.remove('speaking')},5000);
    }
}

// ========== TTS ==========
function queueTTS(p,text){speechQ.push({p,text});if(!isSpeaking)nextTTS()}
function nextTTS(){
    if(!speechQ.length){isSpeaking=false;return}
    isSpeaking=true;const{p,text}=speechQ.shift();
    if(!('speechSynthesis' in window)){setTimeout(nextTTS,1000);return}
    window.speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text);
    u.rate=1.1+Math.random()*0.3;u.pitch=0.7+(p.id%6)*0.12;u.volume=0.6;
    const v=window.speechSynthesis.getVoices();
    if(v.length)u.voice=v[p.id%v.length];
    u.onend=()=>setTimeout(nextTTS,200);
    u.onerror=()=>setTimeout(nextTTS,200);
    window.speechSynthesis.speak(u);
}

// ========== AI ==========
async function callAI(sys,usr,maxTok=120){
    if(!API_KEY)return"I'm thinking...";
    try{
        const r=await fetch(API_URL,{method:'POST',headers:{
            'Authorization':'Bearer '+API_KEY,'Content-Type':'application/json',
            'HTTP-Referer':'https://mafia-game.local','X-Title':'Mafia Game'
        },body:JSON.stringify({model:MODEL,messages:[{role:'system',content:sys},{role:'user',content:usr}],max_tokens:maxTok,temperature:0.9})});
        const d=await r.json();
        if(d.choices&&d.choices[0]&&d.choices[0].message)return d.choices[0].message.content.trim();
        if(d.error)console.error('API error:',d.error);
        return"Hmm, let me think about this...";
    }catch(e){console.error('AI err:',e);return"We need to find the mafia."}
}

// ========== GAME START ==========
function startGame(){
    document.getElementById('main-menu').style.display='none';
    document.getElementById('game-container').style.display='block';
    initPlayers();buildScene();renderSprites();
    dayNum=1;document.getElementById('day-counter').textContent='Day '+dayNum;
    addSys('üéÆ Welcome to Mafia! 20 players: 15 Townies, 1 Doctor, 1 Sheriff, 3 Mafia');
    addSys('The game begins...');
    setTimeout(()=>startDay(),2500);
}

// ========== DAY PHASE ==========
function startDay(){
    gamePhase='day';setDay();
    document.getElementById('phase-display').textContent='‚òÄ DISCUSSION';
    document.getElementById('phase-display').className='phase-day';
    document.getElementById('day-counter').textContent='Day '+dayNum;
    addSys(`‚îÅ‚îÅ‚îÅ ‚òÄ Day ${dayNum} ‚Äî Discussion (${DISCUSS_TIME}s) ‚îÅ‚îÅ‚îÅ`);
    timer=DISCUSS_TIME;updateTimer();
    timerInt=setInterval(()=>{timer--;updateTimer();if(timer<=0){clearInterval(timerInt);startVoting()}},1000);
    runDiscussion();
}

async function runDiscussion(){
    const alive=players.filter(p=>p.alive);
    let order=shuffle([...alive]),idx=0;
    const loop=async()=>{
        if(gamePhase!=='day'||timer<=3)return;
        const sp=order[idx%order.length];idx++;
        if(!sp.alive){setTimeout(loop,300);return}

        const recent=chatHistory.slice(-12).join('\n');
        const mem=sp.memory.slice(-8).join('\n');
        const known=sp.knownInfo.join('\n');
        const dead=players.filter(p=>!p.alive).map(p=>`${p.name}(${p.role})`).join(', ')||'None';
        const aliveNames=alive.filter(p=>p.alive).map(p=>p.name).join(', ');

        const sys=`You are ${sp.name} playing Mafia. Role: ${sp.role}.
Day ${dayNum}. Alive: ${aliveNames}. Dead: ${dead}.
YOUR PRIVATE INFO: ${known||'None'}
RULES: Speak 1-2 short natural sentences. React to others. If Mafia, deflect suspicion subtly. If Town, find Mafia. If Sheriff with info, consider sharing. Never break character. Be conversational and respond to what others said.`;

        const usr=`Recent chat:\n${recent}\n\nYour memories:\n${mem}\n\nSpeak now. React to what was said. Keep it short (1-2 sentences).`;

        try{
            let resp=await callAI(sys,usr,70);
            if(gamePhase==='day'&&sp.alive){
                resp=resp.replace(/^["'*]/,'').replace(/["'*]$/,'').replace(/^\*[^*]+\*\s*/,'');
                if(resp.length>180)resp=resp.substring(0,177)+'...';
                addChat(sp,resp);
                // Track accusations
                alive.forEach(o=>{
                    if(o.id!==sp.id&&resp.toLowerCase().includes(o.name.toLowerCase())){
                        if(['sus','suspicious','mafia','vote','lying','guilty','kill','eliminate','accuse','suspect','shady','fishy'].some(w=>resp.toLowerCase().includes(w))){
                            sp.accusations[o.name]=(sp.accusations[o.name]||0)+1;
                        }
                    }
                });
            }
        }catch(e){console.error(e)}

        const delay=3500+Math.random()*3500;
        if(gamePhase==='day'&&timer>3)setTimeout(loop,delay);
    };
    setTimeout(loop,1500);
}

// ========== VOTING ==========
async function startVoting(){
    gamePhase='voting';speechQ=[];window.speechSynthesis.cancel();
    document.getElementById('phase-display').textContent='‚öñ VOTING';
    document.getElementById('phase-display').className='phase-voting';
    document.getElementById('voting-panel').style.display='block';
    addSys('‚îÅ‚îÅ‚îÅ ‚öñ Voting Phase ‚îÅ‚îÅ‚îÅ');

    const alive=players.filter(p=>p.alive);
    voteRes={};alive.forEach(p=>voteRes[p.name]=0);

    for(const voter of alive){
        const recent=chatHistory.slice(-18).join('\n');
        const acc=Object.entries(voter.accusations).sort((a,b)=>b[1]-a[1]).map(([n,c])=>`${n}(${c}x)`).join(', ');
        const known=voter.knownInfo.join('\n');
        const targets=alive.filter(p=>p.id!==voter.id).map(p=>p.name).join(', ');

        const sys=`You are ${voter.name} (${voter.role}) voting to eliminate someone.
${known}
Your suspicion record: ${acc||'None'}
Available targets: ${targets}
If Mafia: vote for an innocent, NOT your Mafia teammates.
Reply with ONLY one player name.`;

        try{
            const resp=await callAI(sys,`Discussion:\n${recent}\n\nVote for ONE person. Reply with ONLY their name.`,15);
            const target=alive.find(p=>p.id!==voter.id&&resp.toLowerCase().includes(p.name.toLowerCase()));
            if(target&&voteRes[target.name]!==undefined){
                voteRes[target.name]++;
                addSys(`üó≥ ${voter.name} ‚Üí ${target.name}`);
            }else{
                const rnd=alive.filter(p=>p.id!==voter.id);
                const rt=rnd[Math.floor(Math.random()*rnd.length)];
                voteRes[rt.name]++;addSys(`üó≥ ${voter.name} ‚Üí ${rt.name}`);
            }
            updateVotes();
        }catch(e){console.error(e)}
        await sleep(600);
    }
    await sleep(1500);resolveVote();
}

function updateVotes(){
    const c=document.getElementById('vote-tallies');c.innerHTML='';
    Object.entries(voteRes).sort((a,b)=>b[1]-a[1]).forEach(([name,votes])=>{
        if(votes>0){
            const p=players.find(x=>x.name===name);
            const e=document.createElement('div');e.className='vote-entry';
            e.innerHTML=`<span style="color:${p?p.color:'#fff'}">${name}</span>: ${votes}`;
            c.appendChild(e);
        }
    });
}

function resolveVote(){
    const sorted=Object.entries(voteRes).sort((a,b)=>b[1]-a[1]);
    if(sorted.length>0&&sorted[0][1]>0){
        if(sorted.length>1&&sorted[0][1]===sorted[1][1]){
            addSys('‚öñ Tied vote! No one eliminated.');
        }else{
            const victim=players.find(p=>p.name===sorted[0][0]);
            if(victim){
                victim.alive=false;
                addSys(`‚ò† ${victim.name} was eliminated! Role: ${victim.role}`);
                renderSprites();
                if(checkWin())return;
            }
        }
    }
    document.getElementById('voting-panel').style.display='none';
    setTimeout(()=>startNight(),2000);
}

// ========== NIGHT ==========
async function startNight(){
    gamePhase='night';setNight();speechQ=[];window.speechSynthesis.cancel();
    document.getElementById('phase-display').textContent='üåô NIGHT';
    document.getElementById('phase-display').className='phase-night';
    document.getElementById('timer-display').textContent='üåô';
    addSys(`‚îÅ‚îÅ‚îÅ üåô Night ${dayNum} ‚îÅ‚îÅ‚îÅ`);
    nightAct={sheriffTarget:null,sheriffResult:null,doctorTarget:null,mafiaTarget:null};
    await sleep(1500);
    await sheriffPhase();
    await doctorPhase();
    await mafiaPhase();
    resolveNight();
}

async function sheriffPhase(){
    const sh=players.find(p=>p.role==='Sheriff'&&p.alive);
    if(!sh){addSys('Sheriff is dead.');await sleep(800);return}

    const panel=document.getElementById('night-panel');panel.style.display='block';
    document.getElementById('np-title').textContent='üîç Sheriff Investigation';
    document.getElementById('np-content').innerHTML=`<em>${sh.name} is investigating...</em>`;

    const alive=players.filter(p=>p.alive&&p.id!==sh.id);
    const prevInv=sh.knownInfo.filter(k=>k.includes('investigated')).join('\n');
    const recent=chatHistory.slice(-12).join('\n');

    const sys=`You are ${sh.name}, the Sheriff. Choose ONE alive player to investigate.
Alive: ${alive.map(p=>p.name).join(', ')}
Previous investigations: ${prevInv||'None'}
Recent discussion: ${recent}
Reply: "INVESTIGATE: [Name] because [reason]"`;

    try{
        const resp=await callAI(sys,'Who do you investigate tonight?',60);
        const target=alive.find(p=>resp.toLowerCase().includes(p.name.toLowerCase()));
        if(target){
            nightAct.sheriffTarget=target;
            const isM=target.role==='Mafia';
            nightAct.sheriffResult=isM;
            const res=isM?'üî¥ MAFIA':'üü¢ INNOCENT';
            sh.knownInfo.push(`Night ${dayNum}: investigated ${target.name} ‚Üí ${isM?'MAFIA':'NOT Mafia'}`);
            sh.memory.push(`[PRIVATE] Night ${dayNum}: ${target.name} is ${isM?'MAFIA!':'innocent.'}`);
            document.getElementById('np-content').innerHTML=
                `<p style="color:${sh.color}">${sh.name} investigates <b style="color:${target.color}">${target.name}</b></p>
                <p style="font-size:20px;margin:10px 0">${res}</p>
                <p style="color:#888;font-size:11px">${resp}</p>`;
        }
    }catch(e){console.error(e)}
    await sleep(4000);panel.style.display='none';
}

async function doctorPhase(){
    const doc=players.find(p=>p.role==='Doctor'&&p.alive);
    if(!doc){addSys('Doctor is dead.');await sleep(800);return}

    const panel=document.getElementById('night-panel');panel.style.display='block';
    document.getElementById('np-title').textContent='üíä Doctor Protection';
    document.getElementById('np-content').innerHTML=`<em>${doc.name} choosing who to protect...</em>`;

    const alive=players.filter(p=>p.alive);
    const recent=chatHistory.slice(-10).join('\n');

    const sys=`You are ${doc.name}, the Doctor. Choose ONE player to protect tonight.
Alive: ${alive.map(p=>p.name).join(', ')}
Discussion: ${recent}
Reply: "PROTECT: [Name] because [reason]"`;

    try{
        const resp=await callAI(sys,'Who do you protect tonight?',60);
        const target=alive.find(p=>resp.toLowerCase().includes(p.name.toLowerCase()));
        nightAct.doctorTarget=target||doc;
        const chosen=nightAct.doctorTarget;
        document.getElementById('np-content').innerHTML=
            `<p style="color:${doc.color}">${doc.name} protects <b style="color:${chosen.color}">${chosen.name}</b></p>
            <p style="color:#888;font-size:11px;margin-top:5px">${resp}</p>`;
    }catch(e){nightAct.doctorTarget=doc;console.error(e)}
    await sleep(3000);panel.style.display='none';
}

async function mafiaPhase(){
    const mafia=players.filter(p=>p.role==='Mafia'&&p.alive);
    if(!mafia.length)return;

    const panel=document.getElementById('night-panel');panel.style.display='block';
    document.getElementById('np-title').textContent='üî™ Mafia Discussion';

    timer=MAFIA_TIME;updateTimer();
    const ti=setInterval(()=>{timer--;updateTimer();if(timer<=0)clearInterval(ti)},1000);

    const townAlive=players.filter(p=>p.alive&&p.role!=='Mafia');
    let mafiaChat=[];

    addSys('üî™ Mafia wakes up...');

    for(const m of mafia){
        if(timer<=1)break;
        const teammates=mafia.filter(x=>x.id!==m.id&&x.alive).map(x=>x.name).join(', ');
        const sys=`You are ${m.name}, MAFIA. Teammates: ${teammates||'none'}.
Alive town targets: ${townAlive.map(p=>p.name).join(', ')}
Kill priority: Sheriff > Doctor > vocal accusers.
Mafia chat so far: ${mafiaChat.join('\n')||'None'}
Suggest a kill in 1-2 sentences.`;
        try{
            const resp=await callAI(sys,'Who should we kill?',50);
            mafiaChat.push(`${m.name}: ${resp}`);
            document.getElementById('np-content').innerHTML=
                `<p style="color:#ff4444;margin-bottom:8px">Mafia Discussion (${timer}s)</p>`+
                mafiaChat.map(c=>{const n=c.split(':')[0];const pl=players.find(x=>x.name===n);
                return`<p style="color:${pl?pl.color:'#ccc'};font-size:12px;margin:2px 0">${c}</p>`}).join('');
            addChat(m,`*whispers* ${resp}`);
        }catch(e){console.error(e)}
        await sleep(3000);
    }

    clearInterval(ti);

    // Final decision
    const decSys='You are Mafia deciding the final kill. Reply with ONLY one player name.';
    const decUsr=`Mafia discussion:\n${mafiaChat.join('\n')}\nTargets: ${townAlive.map(p=>p.name).join(', ')}\nWho do we kill? ONE name only.`;
    try{
        const resp=await callAI(decSys,decUsr,15);
        const target=townAlive.find(p=>resp.toLowerCase().includes(p.name.toLowerCase()));
        nightAct.mafiaTarget=target||townAlive[Math.floor(Math.random()*townAlive.length)];
    }catch(e){nightAct.mafiaTarget=townAlive[Math.floor(Math.random()*townAlive.length)]}

    panel.style.display='none';
}

function resolveNight(){
    addSys('‚îÅ‚îÅ‚îÅ üåÖ Dawn breaks... ‚îÅ‚îÅ‚îÅ');
    const target=nightAct.mafiaTarget;
    const prot=nightAct.doctorTarget;

    if(target){
        if(prot&&target.id===prot.id){
            addSys(`üíä ${target.name} was attacked but SAVED by the Doctor!`);
            target.memory.push(`Night ${dayNum}: I was attacked but saved!`);
        }else{
            target.alive=false;
            addSys(`‚ò† ${target.name} was killed! Role: ${target.role}`);
            renderSprites();
        }
    }

    if(checkWin())return;
    dayNum++;
    setTimeout(()=>startDay(),3000);
}

// ========== WIN CHECK ==========
function checkWin(){
    const am=players.filter(p=>p.alive&&p.role==='Mafia').length;
    const at=players.filter(p=>p.alive&&p.role!=='Mafia').length;
    if(am===0){endGame('town');return true}
    if(am>=at){endGame('mafia');return true}
    return false;
}

function endGame(winner){
    gamePhase='over';clearInterval(timerInt);speechQ=[];window.speechSynthesis.cancel();
    const ov=document.getElementById('game-over');ov.style.display='flex';
    if(winner==='town'){
        document.getElementById('go-title').textContent='üèÜ TOWN WINS!';
        document.getElementById('go-title').style.color='#66ff66';
        document.getElementById('go-text').textContent='All Mafia eliminated!';
    }else{
        document.getElementById('go-title').textContent='üíÄ MAFIA WINS!';
        document.getElementById('go-title').style.color='#ff4444';
        document.getElementById('go-text').textContent='Mafia has taken over!';
    }
}

function showRoles(){
    const c=document.getElementById('revealed-roles');c.innerHTML='';
    players.forEach(p=>{
        const e=document.createElement('div');e.className='rev-role';e.style.borderColor=p.color;
        let rc='#aaa';
        if(p.role==='Mafia')rc='#ff4444';
        else if(p.role==='Sheriff')rc='#44aaff';
        else if(p.role==='Doctor')rc='#44ff44';
        e.innerHTML=`<b style="color:${p.color}">${p.name}</b> <span style="color:${rc}">‚Äî ${p.role}</span> <span style="color:#555">${p.alive?'(alive)':'(dead)'}</span>`;
        c.appendChild(e);
    });
    document.getElementById('role-reveal').style.display='flex';
}

// ========== UTILS ==========
function updateTimer(){
    const d=document.getElementById('timer-display');
    if(gamePhase==='night'){d.textContent='üåô';return}
    d.textContent=timer;d.style.color=timer<=10?'#ff0000':'#ff4444';
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}

// Load voices
if('speechSynthesis' in window)window.speechSynthesis.onvoiceschanged=()=>window.speechSynthesis.getVoices();
</script>
</body>
</html>
